#　DiscordImageSync機能仕様

1. システム概要

本システムは、Discordをシグナリングおよびデータストレージとして利用し、特定の4名間において、ローカルディレクトリ内の画像ファイルを構造ごと同期するシステムである。 「Hybridヘッダー（テキスト）」と「非標準バイナリデータ」を組み合わせることで、Discord上での画像プレビューを抑制し、専用アプリ間でのみ実ファイル化を可能とする隠蔽化構造を持つ。
2. 前提条件

    ユーザー: 固定の4名。

    共有対象: ユーザーが指定した単一のルートディレクトリ。

    対象ファイル: 画像形式（.jpg, .png, .webp等）。

    通信媒体: Discordサーバー内の特定パブリックチャンネル。

    転送制限: 単一ファイル10MB（隠蔽化後のデータサイズ）を上限とする。

3. コア機能仕様
3.1 ディレクトリ監視とファイル検知

    ルートディレクトリ内の画像ファイルをSHA-256ハッシュで管理する。

    「シャドウディレクトリ」との照合により、未送信・未受信の差分のみを同期対象とする。

3.2 転送データ形式（Hybrid構造）

    データ構造: 画像をそのままアップロードせず、以下のハイブリッド形式で1つのファイル（拡張子 .dat 等）としてパッキングする。

        Hybridヘッダー部（テキスト）: SHA-256、相対パス、ファイルサイズ、送信ステータス、およびバイナリ部のオフセット情報。

        バイナリデータ部: 画像の生データ。Base64化は行わず、バイナリのまま結合する。

    隠蔽化: ヘッダーをファイル先頭に付与することで、Discord側の画像プレビュー機能を無効化し、専用アプリ以外では内容を視認できない状態にする。

    オーバーヘッドの削減: Base64変換を廃止しバイナリを直接扱うことで、転送効率を最大化する。

3.3 転送スケジューリングと衝突回避

    アディッショナルタイム: チャンネル内での他者の書き込みを検知した際、暇時間判定をリセットし、一定の「安全確保待機時間」をタイマーに加算する。

    衝突防止: インターバルとアディッショナルタイムの合計時間を経過した時のみ、送信処理を実行する。

3.4 受信および整合性管理

    テンポラリ処理: 受信した .dat ファイルからヘッダーを読み取り、SHAチェックを実施。その後、.shadow/temp/ にてバイナリ部を抽出し、元の画像ファイルへ復元する。

    配置: 復元された画像は、ヘッダー内の相対パス情報に基づき、ルートディレクトリの正しい階層に自動配置される。

4. 例外処理および手動運用仕様
4.1 転送の健全性

    5分間応答がない、または完結しないパケットは破棄し、再試行可能とする。

    10MBを超えるファイルは自動的に「転送スキップ」としてログに記録する。

4.2 手動再要求と優先度制御

    ファイルが欠落している場合、ユーザー操作により「再要求メッセージ（SHA指定）」をDiscordへ送信する。

    再要求を受けた各クライアントは、自身のキューが空の状態（暇時間）である場合に限り、ラウンドロビン方式で転送を開始する。この際、通常の新規ファイル同期よりも優先度を低く設定する。

5. 設計思想（セキュリティ・リソース）

    隠蔽化によるプライバシー保護: 万が一第三者がDiscordチャンネルを閲覧しても、専用アプリがなければ画像内容を復元できないようにし、意図しないプレビューを防止する。

    ストレージの割り切り: 整合性管理のための管理用ディレクトリ（シャドウディレクトリ）と実ディレクトリの二重保持を許容する。

## 将来の拡張性

  現段階ではテキストヘッダ＋本体バイナリ分離によって実質的な隠蔽が行われているが、将来的にはバイナリ部の暗号化をアドオンとして実装することも視野にいれること

## 複数のサーバーを相手するときの仕様

この場合、アプリ側に**「サーバーID（または設定名）」と「ローカルパス」のペア**を認識させるのが最もスマートです。
ディレクトリ構成の管理イメージ

ユーザーのPC内での配置が以下のようになると想定します。

    共有親ディレクトリ: C:/MySharedFiles/

        srvA/ （サーバーAの4人用。Bot Aが監視）

        srvB/ （サーバーBの2人用。Bot Bが監視）

この構成をアプリに認識させる方法は2通りあります。
方法①：設定ファイル（Config）で紐付け

設定ファイルに、Discordの「チャンネルID」と「ローカルのディレクトリ名」をセットで記述します。

    [Server_A] ChannelID = 123456789 LocalPath = ./shared/srvA

    [Server_B] ChannelID = 987654321 LocalPath = ./shared/srvB

方法②：自動ディレクトリ生成（推奨）

アプリが起動した際、設定されたチャンネルIDに基づいて、自動的にフォルダを作成する方法です。

    SharedRoot/ の直下に、サーバー名やIDのフォルダを自動生成。

    ユーザーはそのフォルダの中に画像を入れるだけで、アプリが「あ、これはサーバーB宛だな」と自動的に判断して転送を開始します。

アプリ内部での処理フロー

アプリが複数の「サーバー」を同時に扱う場合、内部では以下のように動くことになります。

    マルチ監視: srvA と srvB の両方のフォルダを監視対象にする。

    イベント振り分け:

        srvA に画像が投入されたら → サーバーAのチャンネルへ送信。

        srvB に画像が投入されたら → サーバーBのチャンネルへ送信。

    アディッショナルタイムの分離:

        サーバーAで誰かが書き込んでも、サーバーBの送信タイマーには影響させない（独立したインターバル管理）。

